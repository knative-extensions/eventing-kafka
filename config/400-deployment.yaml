apiVersion: apps/v1
kind: Deployment
metadata:
  name: eventing-kafka-channel-controller
  namespace: knative-eventing
  labels:
    app: eventing-kafka-channel-controller
    kafka.eventing.knative.dev/release: devel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eventing-kafka-channel-controller
      name: eventing-kafka-channel-controller
  template:
    metadata:
      labels:
        app: eventing-kafka-channel-controller
        name: eventing-kafka-channel-controller
    spec:
      serviceAccountName: eventing-kafka-channel-controller
      containers:
      - name: eventing-kafka
        image: ko://knative.dev/eventing-kafka/cmd/controller
        imagePullPolicy: IfNotPresent # Must be IfNotPresent or Never if used with ko.local
        ports:
        - containerPort: 8081
          name: metrics
        env:
        - name: SYSTEM_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CONFIG_LOGGING_NAME
          value: config-logging
        - name: CONFIG_LEADERELECTION_NAME
          value: config-leader-election-kafkachannel
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: METRICS_PORT
          value: "8081"
        - name: METRICS_DOMAIN
          value: "eventing-kafka"
        - name: CHANNEL_IMAGE
          value: "ko://knative.dev/eventing-kafka/cmd/channel"
        - name: DISPATCHER_IMAGE
          value: "ko://knative.dev/eventing-kafka/cmd/dispatcher"
        resources:
          requests:
            cpu: 20m
            memory: 25Mi
          limits:
            cpu: 100m
            memory: 50Mi
      # TODO - this is specific to our CP sidecar - so if we're including a template here we need to clean this up to just be an "example"
#      - name: custom-kafka-admin-sidecar
#        # TODO - need to use --strict
#        image: konduit.docker.repositories.sapcdn.io/com.sap.c4konduit/cp-kafka-admin-proxy/dev:tdm
#        imagePullPolicy: Always # Must be IfNotPresent or Never if used with ko.local
#        # TODO - do we need to specify ports here? (since it's internal sidecar?) don't think we do
#        env:
#        - name: SYSTEM_NAMESPACE
#          valueFrom:
#            fieldRef:
#              fieldPath: metadata.namespace
#        - name: CP_API_URL
#          valueFrom:
#            secretKeyRef:
#              name: cloudplatform-api
#              key: url
#        - name: CP_API_USERNAME
#          valueFrom:
#            secretKeyRef:
#              name: cloudplatform-api
#              key: username
#        - name: CP_API_PASSWORD
#          valueFrom:
#            secretKeyRef:
#              name: cloudplatform-api
#              key: password
#        volumeMounts:
#        - mountPath: /etc/konduit
#          name: logging-config
#          readOnly: true
#        # TODO - no idea what these should be for us - but "as small as possible" is the intent ; )
#        resources:
#          requests:
#            cpu: 5m
#            memory: 10Mi
#          limits:
#            cpu: 10m
#            memory: 20Mi
#      # TODO - this is under spec.containers (not our sidecar container)
#      volumes:
#      - name: logging-config
#        configMap:
#          defaultMode: 420
#          name: konduit-logging
